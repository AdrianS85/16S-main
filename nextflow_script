# sudo singularity build qiime_sing.img qiime_sing ### this recipe name ###
# sudo singularity shell --bind data:/tmp --cleanenv --writable-tmpfs qiime_sing.img
# cd /tmp

# Working folders need to be structured as such: 
	# Create directory which will be bound with singularity on the /tmp level (call it "Bind", --bind ./Bind:/tmp). This will take care of problem of temporary files being written in singularity-based /tmp folder that would not have access to disk space otherwise.
	# Create directory inside the Bind directory, which will hold entire analysis (call it "Analysis")
	# After these steps, in a single directory we will have .simg container file and Bind/Analysis directory. 
	# The Bind/Analysis directory must contain:
	# 1) data folder containing files to be analyzed (best .cov format, .gz packed) and sample sheet
	# 2) R workflow files
	# Moreover, I think we bind our folder to singularity /tmp, cause nextflow can creata and change folders here??



BootStrap: docker
From: qiime2/core:2020.8



%environment
        export SHELL=/usr/bin/bash
        export LC_ALL=C.UTF-8
        export LANG=C.UTF-8
        export PATH=$PATH:/root



%post
        apt update
        
        curl -s https://get.nextflow.io | bash
        
        apt install -y parallel build-essential vim

        pip install xmltodict deicode qurro 

        pip install git+https://github.com/bokulich-lab/RESCRIPt.git

  ##########################################################

        pip install redbiom

        pip install q2-clawback

        alias R="/opt/conda/bin/R"

        conda install -c bioconda -c conda-forge -c r bioconductor-phyloseq r-devtools r-tibble r-magrittr r-dplyr r-withr r-testthat r-praise unzip r-vegan

        pip install git+https://github.com/statdivlab/q2-breakaway.git

        R -e 'Sys.setenv(TAR = "/bin/tar"); library(devtools); devtools::install_github("adw96/breakaway"); devtools::install_github("benjjneb/dada2")'

        qiime dev refresh-cache
        
        
        
  ##########################################################
      
        
        alias R="/opt/conda/envs/qiime2-2020.8/bin/R"
        enter /opt/conda/envs/qiime2-2020.8/bin/R,   install.packages("git2r") install.packages("devtools")
        
        
        
        --configure-vars='LIBS=-L/path/to/libs CPPFLAGS=-I/path/to/headers'
        
        
        /usr/include/
        
        /opt/conda/envs/qiime2-2020.8/include/
        
        Sys.setenv("LIBS"=paste0(Sys.getenv("LIBS"), ":/usr/lib/x86_64-linux-gnu"))
        Sys.setenv("CPPFLAGS"=paste0(Sys.getenv("CPPFLAGS"), ":/opt/conda/include"))
        install.packages("git2r")
        
        Sys.setenv("LIBS"=paste0(Sys.getenv("LIBS"), ":/usr/share/doc/"))
        Sys.setenv("CPPFLAGS"=paste0(Sys.getenv("LIBS"), ":/opt/conda/envs/qiime2-2020.8/include/"))
        
        
        
        
        
        
        
        
        
        
        
        

